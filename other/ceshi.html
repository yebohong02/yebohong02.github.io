<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIè¥å…»éšè®¿ç®¡ç†ç³»ç»Ÿï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { width: 95%; max-width: 1400px; background: rgba(255,255,255,0.98); border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; text-align: center; color: white; }
        .header h1 { font-size: 2rem; margin-bottom: 6px; }
        .role-switch { display:flex; justify-content:center; margin-top:10px; }
        .role-switch select { padding:8px 16px; border-radius:20px; font-weight:bold; }
        .sub-nav { display: flex; background: white; border-bottom: 2px solid #f0f0f0; }
        .sub-nav-btn { flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; transition: all 0.25s; color: #666; }
        .sub-nav-btn.active { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .third-nav { display: flex; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .third-nav-btn { flex: 1; padding: 10px; background: none; border: none; cursor: pointer; font-size: 0.95rem; font-weight: bold; color: #555; }
        .third-nav-btn.active { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
        .content { padding: 30px; min-height: 600px; }
        .section { display: none; }
        .section.active { display: block; }
        .sub-section { display: none; }
        .sub-section.active { display: block; }
        .third-section { display: none; }
        .third-section.active { display: block; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.06); border: 1px solid #f0f0f0; }
        .card h3 { color: #333; margin-bottom: 15px; font-size: 1.25rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display:block; margin-bottom:6px; font-weight:600; color:#444; }
        input[type=text], input[type=number], input[type=date], select, textarea { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:1rem; }
        .btn { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:700; }
        .btn-secondary { background: linear-gradient(135deg,#a8edea 0%,#fed6e3 100%); color:#333; }
        .stats-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:20px; }
        .stat-card { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:18px; border-radius:12px; text-align:center; }
        .patient-list { max-height:400px; overflow-y:auto; }
        .patient-item { background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:12px; margin-bottom:10px; cursor:pointer; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color:white; margin:4% auto; padding:20px; border-radius:12px; width:90%; max-width:800px; max-height:80vh; overflow-y:auto; }
        .close { float:right; font-size:28px; cursor:pointer; }
        .message-board { background:#f0f9f9; border-radius:8px; padding:12px; height:120px; overflow-y:auto; border:1px solid #ccc; }
        .message { margin-bottom:8px; padding:8px; border-radius:6px; max-width:80%; }
        .patient-msg { background:#e8f6ff; border-left:4px solid #3aafa9; }
        .doctor-msg { background:#fff4e6; border-left:4px solid #f29e4c; }
        .timestamp { font-size:0.75rem; color:#666; margin-top:6px; }
        .file-list { max-height:200px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:8px; padding:10px; margin-top:10px; }
        .file-item { padding:8px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; }
        .file-item:last-child { border-bottom:none; }
        .error-message { color:#e74c3c; font-size:0.9rem; margin-top:5px; display:none; }
        @media (max-width:768px){ .container{width:100%;border-radius:0;} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ AIè¥å…»éšè®¿ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="role-switch">
                <select id="roleSelect" onchange="switchRole()">
                    <option value="doctor">ğŸ‘¨â€âš•ï¸ åŒ»å¸ˆç«¯</option>
                    <option value="patient">ğŸ‘¤ æ‚£è€…ç«¯</option>
                </select>
            </div>
        </div>

        <div class="content">
            <!-- åŒ»å¸ˆç«¯ -->
            <div id="doctor" class="section active">
                <div class="sub-nav">
                    <button class="sub-nav-btn active" onclick="showDoctorSubSection('work')">å·¥ä½œç«¯</button>
                    <button class="sub-nav-btn" onclick="showDoctorSubSection('data')">æ•°æ®ç®¡ç†</button>
                    <button class="sub-nav-btn" onclick="showDoctorSubSection('research')">ç§‘ç ”æ”¯æŒ</button>
                </div>

                <!-- å·¥ä½œç«¯ -->
                <div id="doctor-work" class="sub-section active">
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-number" id="statPatients">127</div><div class="stat-label">åœ¨ç®¡æ‚£è€…</div></div>
                        <div class="stat-card"><div class="stat-number" id="statAdherence">85%</div><div class="stat-label">éšè®¿ä¾ä»æ€§</div></div>
                        <div class="stat-card"><div class="stat-number" id="statInterventions">23</div><div class="stat-label">æœ¬å‘¨å¹²é¢„</div></div>
                        <div class="stat-card"><div class="stat-number" id="statTargets">76%</div><div class="stat-label">ç›®æ ‡è¾¾æˆç‡</div></div>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>ğŸ“‹ æ‚£è€…ç®¡ç†å°è´¦</h3>
                            <div class="form-group">
                                <button class="btn" onclick="openNewPatientModal()">+ æ–°å»ºæ‚£è€…æ¡£æ¡ˆ</button>
                                <button class="btn btn-secondary" onclick="exportAllData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                            </div>
                            <div class="patient-list" id="patientList"></div>
                        </div>

                        <div class="card">
                            <h3>ğŸ“Š æ‚£è€…è¯¦æƒ…åˆ†æ</h3>
                            <div id="selectedPatient">è¯·ä»å·¦ä¾§é€‰æ‹©æ‚£è€…æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>ğŸ“¤ æ–‡ä»¶ä¸­å¿ƒï¼ˆåŒ»å¸ˆï¼‰</h3>
                        <div class="form-group">
                            <label>ä¸Šä¼ è¯„ä¼°æŠ¥å‘Š/ç—…ä¾‹æ–‡ä»¶</label>
                            <input type="file" id="doctorFileInput">
                            <button class="btn" onclick="uploadFileToServer('doctor')">ä¸Šä¼ </button>
                        </div>
                        <div class="form-group">
                            <label>å¹³å°æ¥æ”¶çš„æ‚£è€…æ–‡ä»¶</label>
                            <div id="doctorReceivedFiles"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>ğŸ’¬ åŒ»å¸ˆ â€” æ‚£è€… èŠå¤©</h3>
                        <div class="grid">
                            <div>
                                <label>é€‰æ‹©ä¼šè¯æ‚£è€…</label>
                                <select id="chatPatientSelect" onchange="switchChatPatient()"></select>
                            </div>
                            <div>
                                <label>æ¶ˆæ¯</label>
                                <div class="message-board" id="chatBoard">æš‚æ— æ¶ˆæ¯è®°å½•...</div>
                                <div style="display:flex;gap:8px;margin-top:8px;">
                                    <input type="text" id="chatInputDoctor" placeholder="è¾“å…¥æ¶ˆæ¯...">
                                    <button class="btn" onclick="sendChat('doctor')">å‘é€</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>ğŸ“Š æ•°æ®å¯è§†åŒ–ä»ªè¡¨æ¿ï¼ˆå·¥ä½œç«¯ï¼‰</h3>
                        <div class="chart-container" style="height:320px;"><canvas id="overallChart"></canvas></div>
                    </div>
                </div>

                <!-- æ•°æ®ç®¡ç†å†…å®¹ -->
                <div id="doctor-data" class="sub-section">
                    <div class="card">
                        <h3>ğŸ“Š æ•°æ®å¯è§†åŒ–ä»ªè¡¨æ¿</h3>
                        <div class="chart-container" style="height:320px;"><canvas id="dataOverallChart"></canvas></div>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>ğŸ“¥ æ•°æ®å¯¼å‡ºå·¥å…·</h3>
                            <div class="form-group"><label>å¯¼å‡ºèŒƒå›´</label><select id="exportRange"><option>å…¨éƒ¨æ‚£è€…</option><option>æŒ‡å®šæ‚£è€…</option><option>ç‰¹å®šç–¾ç—…ç±»å‹</option></select></div>
                            <div class="form-group"><label>æ—¶é—´èŒƒå›´</label><input type="date" id="exportStart"> <input type="date" id="exportEnd"></div>
                            <div class="form-group"><label>å¯¼å‡ºæ ¼å¼</label><select id="exportFormat"><option>Excel (.xlsx)</option><option>PDF æŠ¥å‘Š</option><option>CSV æ•°æ®</option></select></div>
                            <button class="btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                        </div>

                        <div class="card">
                            <h3>ğŸ” æ•°æ®è´¨é‡ç›‘æ§</h3>
                            <div id="dataQualitySummary" style="background:#f8f9fa;padding:12px;border-radius:8px;"></div>
                            <button class="btn btn-secondary" onclick="viewAnomalies()">ğŸ” æŸ¥çœ‹å¼‚å¸¸æ•°æ®</button>
                        </div>
                    </div>
                </div>

                <!-- ç§‘ç ”æ”¯æŒå†…å®¹ï¼ˆä¸‰çº§å¯¼èˆªï¼‰ -->
                <div id="doctor-research" class="sub-section">
                    <div class="third-nav">
                        <button class="third-nav-btn active" onclick="showResearchThirdSection('project')">ç ”ç©¶é¡¹ç›®</button>
                        <button class="third-nav-btn" onclick="showResearchThirdSection('stat')">ç»Ÿè®¡åˆ†æ</button>
                    </div>

                    <!-- ç ”ç©¶é¡¹ç›® -->
                    <div id="research-project" class="third-section active">
                        <div class="card">
                            <h3>ğŸ”¬ ç ”ç©¶é¡¹ç›®ç®¡ç†</h3>
                            <div class="form-group"><label>é¡¹ç›®åç§°</label><input type="text" id="researchName" placeholder="ç¤ºä¾‹ï¼šç³–å°¿ç—…è¥å…»å¹²é¢„ç ”ç©¶"></div>
                            <div class="form-group"><label>ç ”ç©¶ç±»å‹</label><select id="researchType"><option>æ¨ªæ–­é¢ç ”ç©¶</option><option>é˜Ÿåˆ—ç ”ç©¶</option><option>å¹²é¢„ç ”ç©¶</option><option>ç—…ä¾‹å¯¹ç…§ç ”ç©¶</option></select></div>
                            <div class="form-group"><label>ç­›é€‰æ¡ä»¶</label><textarea id="researchFilter" rows="3" placeholder="å¹´é¾„>18; è¯Šæ–­2å‹ç³–å°¿ç—…; éšè®¿>=3ä¸ªæœˆ"></textarea></div>
                            <button class="btn" onclick="createResearchProject()">ğŸ”¬ åˆ›å»ºç ”ç©¶é¡¹ç›®</button>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡åˆ†æ -->
                    <div id="research-stat" class="third-section">
                        <div class="card">
                            <h3>ğŸ“ˆ ç»Ÿè®¡åˆ†æå·¥å…·</h3>
                            <div class="form-group"><label>é€‰æ‹©æŒ‡æ ‡</label><select id="statIndicators" multiple style="height:90px;"><option>BMIå˜åŒ–</option><option>è¡€ç³–æ§åˆ¶</option><option>é¥®é£Ÿä¾ä»æ€§</option><option>ä½“é‡å˜åŒ–</option><option>è¥å…»ç´ æ‘„å…¥</option></select></div>
                            <div class="form-group"><label>åˆ†ç»„å˜é‡</label><select id="statGroup"><option>ç–¾ç—…ç±»å‹</option><option>å¹´é¾„ç»„</option><option>æ€§åˆ«</option><option>å¹²é¢„æ–¹å¼</option></select></div>
                            <button class="btn" onclick="generateStatReport()">ğŸ“Š ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‚£è€…ç«¯ -->
            <div id="patient" class="section">
                <div class="grid">
                    <div class="card">
                        <h3>ğŸ“± ä¸ªäººæ¡£æ¡ˆè®¾ç½®</h3>
                        <div class="form-group"><label>å§“å</label><input type="text" id="patientNameInput" value="å¼ ä¸‰"></div>
                        <div class="form-group"><label>ç–¾ç—…ç±»å‹</label><select id="patientDisease"><option>ç³–å°¿ç—…</option><option>è‚¥èƒ–ç—‡</option><option>ä»£è°¢ç»¼åˆå¾</option><option>è‚¿ç˜¤åº·å¤</option><option>æœ¯ååº·å¤</option></select></div>
                        <div class="form-group"><label>è¥å…»ç›®æ ‡</label><select id="patientGoal"><option>è¡€ç³–æ§åˆ¶</option><option>å‡è„‚ç˜¦èº«</option><option>å¢è‚Œå¡‘å½¢</option><option>è¥å…»å‡è¡¡</option></select></div>
                        <button class="btn" onclick="savePatientProfile()">ğŸ’¾ ä¿å­˜æ¡£æ¡ˆ</button>
                    </div>

                    <div class="card">
                        <h3>ğŸ± é¥®é£Ÿæ‹ç…§æ‰“å¡ / ä¸Šä¼ æ„è§æ–‡ä»¶ï¼ˆåŒä¸Šä¼ æ¡†ï¼‰</h3>
                        <div class="form-group"><label>1) ä¸Šä¼ é¥®é£Ÿå›¾ç‰‡ï¼ˆAIåˆ†æï¼‰</label><input type="file" id="foodImageInput" accept="image/*"><button class="btn" onclick="uploadFoodImage()">ä¸Šä¼ å¹¶AIåˆ†æ</button></div>
                        <div class="form-group"><label>2) ä¸Šä¼ æ„è§/ç—…ä¾‹æ–‡ä»¶ï¼ˆå¯ä¾›åŒ»å¸ˆä¸‹è½½ï¼‰</label><input type="file" id="patientFileInput"><button class="btn" onclick="uploadPatientFile()">ä¸Šä¼ æ–‡ä»¶</button></div>
                        <div id="foodAnalysisArea"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ“ˆ ä½“å¾è®°å½•ä¸è¶‹åŠ¿</h3>
                    <div class="grid">
                        <div>
                            <div class="form-group">
                                <label>ä½“é‡ (kg)</label>
                                <input type="number" id="inputWeight" placeholder="75.5">
                                <div class="error-message" id="weightError">è¯·è¾“å…¥ä½“é‡</div>
                            </div>
                            <div class="form-group">
                                <label>è…°å›´ (cm)</label>
                                <input type="number" id="inputWaist" placeholder="86">
                                <div class="error-message" id="waistError">è¯·è¾“å…¥è…°å›´</div>
                            </div>
                            <div class="form-group">
                                <label>è¡€ç³– (mmol/L)</label>
                                <input type="number" id="inputGlucose" placeholder="6.8">
                                <div class="error-message" id="glucoseError">è¯·è¾“å…¥è¡€ç³–</div>
                            </div>
                            <button class="btn" onclick="recordVitals()">ğŸ“Š è®°å½•æ•°æ®</button>
                        </div>
                        <div>
                            <div class="chart-container" style="height:300px;"><canvas id="weightChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ“¬ åŒ»ç”Ÿå»ºè®®ä¸AIåé¦ˆ</h3>
                    <div class="ai-suggestion" id="aiSuggestionArea">
                        <h4>ğŸ§  ä»Šæ—¥AIå»ºè®®</h4>
                        <ul id="aiSuggestionList"></ul>
                    </div>
                    <div style="background:#e3f2fd;padding:12px;border-radius:8px;">
                        <h4>ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿæœ€æ–°å»ºè®®</h4>
                        <p id="latestDoctorAdvice">æš‚æ— </p>
                        <small id="latestAdviceTime" style="color:#666"></small>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ“‚ æˆ‘çš„æ–‡ä»¶</h3>
                    <div class="form-group">
                        <label>æˆ‘ä¸Šä¼ çš„ç—…ä¾‹æ–‡ä»¶</label>
                        <div id="patientFiles" class="file-list"></div>
                    </div>
                    <div class="form-group">
                        <label>åŒ»å¸ˆè¯„ä¼°æŠ¥å‘Š</label>
                        <div id="doctorReports" class="file-list"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>ğŸ’¬ æ‚£è€… â€” åŒ»å¸ˆ èŠå¤©</h3>
                    <div class="message-board" id="patientChatBoard">æš‚æ— æ¶ˆæ¯è®°å½•...</div>
                    <div style="display:flex;gap:8px;margin-top:8px;"><input type="text" id="chatInputPatient" placeholder="è¾“å…¥æ¶ˆæ¯..."><button class="btn" onclick="sendChat('patient')">å‘é€</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºæ‚£è€…æ¨¡æ€æ¡† -->
    <div id="newPatientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewPatientModal()">&times;</span>
            <h2>æ–°å»ºæ‚£è€…æ¡£æ¡ˆ</h2>
            <div class="form-group"><label>æ‚£è€…å§“å</label><input type="text" id="newPatientName"></div>
            <div class="form-group"><label>å¹´é¾„</label><input type="number" id="newPatientAge"></div>
            <div class="form-group"><label>æ€§åˆ«</label><select id="newPatientSex"><option>ç”·</option><option>å¥³</option></select></div>
            <div class="form-group"><label>ç–¾ç—…ç±»å‹</label><select id="newPatientDisease"><option>ç³–å°¿ç—…</option><option>è‚¥èƒ–ç—‡</option><option>ä»£è°¢ç»¼åˆå¾</option><option>è‚¿ç˜¤</option><option>æœ¯ååº·å¤</option></select></div>
            <div class="form-group"><label>åŸºç¡€ä½“é‡ (kg)</label><input type="number" id="newPatientWeight"></div>
            <div class="form-group"><label>èº«é«˜ (cm)</label><input type="number" id="newPatientHeight"></div>
            <button class="btn" onclick="createPatient()">ğŸ’¾ ä¿å­˜æ‚£è€…æ¡£æ¡ˆ</button>
        </div>
    </div>

    <!-- å‘é€å»ºè®®æ¨¡æ€æ¡† -->
    <div id="sendAdviceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSendAdviceModal()">&times;</span>
            <h2>å‘é€å»ºè®®</h2>
            <div class="form-group"><label>å»ºè®®å†…å®¹</label><textarea id="adviceText" rows="4" placeholder="è¯·è¾“å…¥ç»™æ‚£è€…çš„å»ºè®®..."></textarea></div>
            <button class="btn" onclick="confirmSendAdvice()">å‘é€</button>
        </div>
    </div>

    <script>
        /* ================= åŸºç¡€æ•°æ® ================= */
        const patients = [
            {id:'P001', name:'å¼ ä¸‰', age:45, sex:'ç”·', disease:'ç³–å°¿ç—…', lastFollow:'2025-09-03', adherence:'è‰¯å¥½', weightHistory:[78.5,77.8,77.2,76.9,76.3,75.8]},
            {id:'P002', name:'æå››', age:50, sex:'å¥³', disease:'è‚¥èƒ–ç—‡', lastFollow:'2025-09-02', adherence:'å¾…æ”¹å–„', weightHistory:[95,94,93.5,93,92.5,92]},
            {id:'P003', name:'ç‹äº”', age:60, sex:'ç”·', disease:'ä»£è°¢ç»¼åˆå¾', lastFollow:'2025-09-01', adherence:'ä¼˜ç§€', weightHistory:[82,81.5,81,80.6,80,79.6]}
        ];
        const sharedFiles = [];
	const messages = [];
        let currentSelectedPatientId = 'P002';

        /* ================= è§’è‰²åˆ‡æ¢ ================= */
        function switchRole(){
            const role = document.getElementById('roleSelect').value;
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById(role).classList.add('active');
            if(role==='patient') {
                initWeightChart();
                renderPatientFiles();
                renderDoctorReports();
            }
        }

        /* ================= åŒ»å¸ˆç«¯å­åˆ‡æ¢ ================= */
        function showDoctorSubSection(sub){
            document.querySelectorAll('.sub-section').forEach(s=>s.classList.remove('active'));
            document.getElementById('doctor-'+sub).classList.add('active');
            document.querySelectorAll('.sub-nav-btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
        }

        /* ================= ç§‘ç ”æ”¯æŒä¸‰çº§åˆ‡æ¢ ================= */
        function showResearchThirdSection(sub){
            document.querySelectorAll('.third-section').forEach(s=>s.classList.remove('active'));
            document.getElementById('research-'+sub).classList.add('active');
            document.querySelectorAll('.third-nav-btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
        }

        /* ================= åˆå§‹æ¸²æŸ“ ================= */
        document.addEventListener('DOMContentLoaded', ()=>{
            renderPatientList();
            populateChatPatientSelect();
            initWeightChart();
            initOverallChart();
            initDataCharts();
            initDataQuality();
            // é»˜è®¤æ—¥æœŸ
            const end = new Date().toISOString().split('T')[0];
            const start = new Date(); start.setMonth(start.getMonth()-1);
            document.getElementById('exportEnd').value = end;
            document.getElementById('exportStart').value = start.toISOString().split('T')[0];
            // AIå»ºè®®
            const suggestions = ['æ‚¨çš„è¡€ç³–æ§åˆ¶è‰¯å¥½ï¼Œç»§ç»­ä¿æŒå½“å‰é¥®é£Ÿæ¨¡å¼','å»ºè®®å¢åŠ 30åˆ†é’Ÿæœ‰æ°§è¿åŠ¨','æ³¨æ„è¡¥å……è†³é£Ÿçº¤ç»´ï¼Œæ¨èç‡•éº¦ã€è”¬èœç±»'];
            const list = document.getElementById('aiSuggestionList');
            suggestions.forEach(s=>{const li=document.createElement('li');li.textContent=s;list.appendChild(li);});
            // èŠå¤©
            renderChatBoard();
        });

        /* ================= æ‚£è€…ç®¡ç† ================= */
        function renderPatientList(){
            const container = document.getElementById('patientList'); container.innerHTML='';
            patients.forEach(p=>{
                const div = document.createElement('div'); div.className='patient-item';
                div.innerHTML = `<div class="patient-name">${p.name} (ID: ${p.id})</div><div class="patient-info">${p.disease} | æœ€åéšè®¿: ${p.lastFollow} | ä¾ä»æ€§: ${p.adherence}</div>`;
                div.onclick = ()=> selectPatient(p.id);
                container.appendChild(div);
            });
            document.getElementById('statPatients').textContent = patients.length;
        }
        function selectPatient(patientId){
            currentSelectedPatientId = patientId;
            const p = patients.find(x=>x.id===patientId);
            const detailDiv = document.getElementById('selectedPatient');
            detailDiv.innerHTML = `<h4>æ‚£è€…: ${p.name}</h4><div style="background:#f8f9fa;padding:12px;border-radius:8px;margin:12px 0;"><p><strong>åŸºæœ¬ä¿¡æ¯:</strong> ${p.sex}, ${p.age}å², BMI: ${(p.weightHistory && p.weightHistory.length)?( (p.weightHistory[p.weightHistory.length-1]/((1.7)*(1.7))).toFixed(1) ):'--'}</p><p><strong>è¯Šæ–­:</strong> ${p.disease}</p><p><strong>éšè®¿é¢‘ç‡:</strong> æ¯å‘¨2æ¬¡</p><p><strong>å½“å‰ç›®æ ‡:</strong> è¡€ç³–æ§åˆ¶ + å‡é‡5kg</p></div><div class="chart-container" style="height:220px;"><canvas id="patientChart"></canvas></div><button class="btn" onclick="openSendAdviceModal()">ğŸ“¤ å‘é€å»ºè®®</button> <button class="btn btn-secondary" onclick="downloadPatientReport('${p.id}')">ğŸ“¥ ä¸‹è½½æŠ¥å‘Š</button>`;
            setTimeout(initPatientChart,100);
        }

        /* ================= æ–°å»ºæ‚£è€… ================= */
        function openNewPatientModal(){ document.getElementById('newPatientModal').style.display='block'; }
        function closeNewPatientModal(){ document.getElementById('newPatientModal').style.display='none'; }
        function createPatient(){
            const name = document.getElementById('newPatientName').value.trim();
            if(!name){ alert('è¯·è¾“å…¥å§“å'); return; }
            const id = 'P' + String(Math.floor(Math.random()*900+100));
            const age = document.getElementById('newPatientAge').value || '--';
            const sex = document.getElementById('newPatientSex').value;
            const disease = document.getElementById('newPatientDisease').value;
            const weight = document.getElementById('newPatientWeight').value || 0;
            const height = document.getElementById('newPatientHeight').value || 0;
            patients.push({id, name, age, sex, disease, lastFollow: new Date().toISOString().split('T')[0], adherence:'æœªçŸ¥', weightHistory: weight? [parseFloat(weight)]:[]});
            renderPatientList(); closeNewPatientModal(); alert('æ‚£è€…æ¡£æ¡ˆå·²åˆ›å»º: ' + name);
            populateChatPatientSelect();
        }

        /* ================= æ–‡ä»¶ ================= */
        function uploadFileToServer(uploader){
            const input = document.getElementById(uploader+'FileInput');
            if(!input || input.files.length===0){ alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶'); return; }
            const file = input.files[0];
            const id = 'F' + Date.now();
            const patientId = currentSelectedPatientId;
            const blobUrl = URL.createObjectURL(file);
            sharedFiles.push({id, filename:file.name, uploader, patientId, date: new Date().toLocaleString(), blobUrl});
            renderDoctorReceivedFiles();
            input.value = '';
            alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ' + file.name);
        }
        function uploadPatientFile(){
            const input = document.getElementById('patientFileInput');
            if(!input || input.files.length===0){ alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶'); return; }
            const file = input.files[0];
            const patientName = document.getElementById('patientNameInput').value || patients[0].name;
            const p = patients.find(pp=>pp.name===patientName) || patients[0];
            const id = 'F' + Date.now();
            const blobUrl = URL.createObjectURL(file);
            sharedFiles.push({id, filename:file.name, uploader:'patient', patientId:p.id, date:new Date().toLocaleString(), blobUrl});
            renderDoctorReceivedFiles(); 
            renderPatientFiles();
            input.value=''; 
            alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸå¹¶å·²å‘é€ç»™åŒ»å¸ˆ: '+file.name);
        }
        function renderDoctorReceivedFiles(){
            const container = document.getElementById('doctorReceivedFiles'); container.innerHTML='';
            if(sharedFiles.length===0){ container.innerHTML='<p style="color:#666">æš‚æ— æ–‡ä»¶</p>'; return; }
            sharedFiles.forEach(f=>{
                const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid #eee';
                div.innerHTML = `<div><strong>${f.filename}</strong> <small style="color:#666">[${f.date}]</small></div><div>æ‚£è€…ID: ${f.patientId} | ä¸Šä¼ è€…: ${f.uploader}</div><div style="margin-top:6px;"><button class="btn" onclick="downloadSharedFile('`+f.id+`')">ä¸‹è½½</button> <button class="btn btn-secondary" onclick="deleteSharedFile('`+f.id+`')">åˆ é™¤</button></div>`;
                container.appendChild(div);
            });
        }
        function renderPatientFiles(){
            const container = document.getElementById('patientFiles'); container.innerHTML='';
            const patientName = document.getElementById('patientNameInput').value || patients[0].name;
            const p = patients.find(pp=>pp.name===patientName) || patients[0];
            const patientFiles = sharedFiles.filter(f=>f.patientId===p.id && f.uploader==='patient');
            
            if(patientFiles.length===0){ container.innerHTML='<p style="color:#666">æš‚æ— æ–‡ä»¶</p>'; return; }
            
            patientFiles.forEach(f=>{
                const div = document.createElement('div'); div.className='file-item';
                div.innerHTML = `<span>${f.filename}</span><button class="btn" onclick="downloadSharedFile('`+f.id+`')">ä¸‹è½½</button>`;
                container.appendChild(div);
            });
        }
        function renderDoctorReports(){
            const container = document.getElementById('doctorReports'); container.innerHTML='';
            const patientName = document.getElementById('patientNameInput').value || patients[0].name;
            const p = patients.find(pp=>pp.name===patientName) || patients[0];
            const doctorFiles = sharedFiles.filter(f=>f.patientId===p.id && f.uploader==='doctor');
            
            if(doctorFiles.length===0){ container.innerHTML='<p style="color:#666">æš‚æ— æŠ¥å‘Š</p>'; return; }
            
            doctorFiles.forEach(f=>{
                const div = document.createElement('div'); div.className='file-item';
                div.innerHTML = `<span>${f.filename}</span><button class="btn" onclick="downloadSharedFile('`+f.id+`')">ä¸‹è½½</button>`;
                container.appendChild(div);
            });
        }
        function downloadSharedFile(fileId){
            const f = sharedFiles.find(x=>x.id===fileId);
            if(!f){ alert('æ–‡ä»¶ä¸å­˜åœ¨'); return; }
            const a = document.createElement('a'); a.href = f.blobUrl; a.download = f.filename; document.body.appendChild(a); a.click(); a.remove();
        }
        function deleteSharedFile(fileId){
            const idx = sharedFiles.findIndex(x=>x.id===fileId); 
            if(idx>-1){ 
                sharedFiles.splice(idx,1); 
                renderDoctorReceivedFiles(); 
                renderPatientFiles();
                renderDoctorReports();
            }
        }

        /* ================= èŠå¤© ================= */
        function populateChatPatientSelect(){
            const sel = document.getElementById('chatPatientSelect'); sel.innerHTML='';
            patients.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent = p.name + ' ('+p.id+')'; sel.appendChild(opt); });
            if(currentSelectedPatientId) sel.value = currentSelectedPatientId;
        }
        function switchChatPatient(){ currentSelectedPatientId = document.getElementById('chatPatientSelect').value; renderChatBoard(); }
        function addMessageToStore(patientId, sender, text){ messages.push({patientId, sender, text, time:new Date().toLocaleString()}); }
        function renderChatBoard(){
            const board = document.getElementById('chatBoard'); const pb = document.getElementById('patientChatBoard'); board.innerHTML=''; pb.innerHTML='';
            const patientMsgs = messages.filter(m=>m.patientId===currentSelectedPatientId);
            if(patientMsgs.length===0){ board.innerHTML='<p style="color:#777">æš‚æ— æ¶ˆæ¯è®°å½•...</p>'; pb.innerHTML='<p style="color:#777">æš‚æ— æ¶ˆæ¯è®°å½•...</p>'; return; }
            patientMsgs.forEach(m=>{
                const div = document.createElement('div'); div.className='message '+(m.sender==='patient'?'patient-msg':'doctor-msg'); div.innerHTML = `<div>${(m.sender==='patient'?'æ‚£è€…':'åŒ»å¸ˆ')}: ${m.text}</div><div class="timestamp">${m.time}</div>`;
                board.appendChild(div);
                const div2 = div.cloneNode(true); pb.appendChild(div2);
            });
            board.scrollTop = board.scrollHeight; pb.scrollTop = pb.scrollHeight;
        }
        function sendChat(role){
            const input = document.getElementById(role==='doctor'?'chatInputDoctor':'chatInputPatient');
            const text = input.value.trim(); if(!text){ alert('è¯·è¾“å…¥æ¶ˆæ¯ï¼'); return; }
            const pid = currentSelectedPatientId || patients[0].id;
            addMessageToStore(pid, role==='doctor'?'doctor':'patient', text);
            renderChatBoard(); input.value='';
            if(role==='doctor'){ document.getElementById('latestDoctorAdvice').textContent = text; document.getElementById('latestAdviceTime').textContent = new Date().toLocaleString(); }
        }

        /* ================= ä½“å¾ & å›¾è¡¨ ================= */
        function recordVitals(){
            let hasError = false;
            
            // éªŒè¯ä½“é‡
            const weight = document.getElementById('inputWeight').value;
            if(!weight){
                document.getElementById('weightError').style.display = 'block';
                hasError = true;
            } else {
                document.getElementById('weightError').style.display = 'none';
            }
            
            // éªŒè¯è…°å›´
            const waist = document.getElementById('inputWaist').value;
            if(!waist){
                document.getElementById('waistError').style.display = 'block';
                hasError = true;
            } else {
                document.getElementById('waistError').style.display = 'none';
            }
            
            // éªŒè¯è¡€ç³–
            const glucose = document.getElementById('inputGlucose').value;
            if(!glucose){
                document.getElementById('glucoseError').style.display = 'block';
                hasError = true;
            } else {
                document.getElementById('glucoseError').style.display = 'none';
            }
            
            if(hasError) return;
            
            const w = parseFloat(weight);
            const p = patients.find(x=>x.id===currentSelectedPatientId) || patients[0]; 
            p.weightHistory = p.weightHistory || []; 
            p.weightHistory.push(w); 
            alert('ä½“å¾è®°å½•å·²ä¿å­˜'); 
            initWeightChart(); 
            selectPatient(p.id);
        }
        function initWeightChart(){
            const ctx = document.getElementById('weightChart'); if(!ctx) return;
            const p = patients.find(x=>x.id===currentSelectedPatientId) || patients[0]; const labels = ['8å‘¨å‰','6å‘¨å‰','4å‘¨å‰','3å‘¨å‰','2å‘¨å‰','æœ¬å‘¨']; const data = (p.weightHistory && p.weightHistory.length>=6)? p.weightHistory.slice(-6) : [78.5,77.8,77.2,76.9,76.3,75.8];
            try{ new Chart(ctx,{type:'line',data:{labels, datasets:[{label:'ä½“é‡ (kg)', data, borderColor:'#4facfe', backgroundColor:'rgba(79,172,254,0.1)', tension:0.4, fill:true}]}, options:{responsive:true, maintainAspectRatio:false}});}catch(e){console.warn(e);}
        }
        function initPatientChart(){
            const ctx = document.getElementById('patientChart'); if(!ctx) return; const p = patients.find(x=>x.id===currentSelectedPatientId) || patients[0]; const labels = ['ç¬¬1å‘¨','ç¬¬2å‘¨','ç¬¬3å‘¨','ç¬¬4å‘¨']; const data1 = [75,82,88,91]; const data2 = [60,70,78,85];
            try{ new Chart(ctx,{type:'bar', data:{labels, datasets:[{label:'é¥®é£Ÿä¾ä»æ€§ (%)', data:data1, backgroundColor:'rgba(79,172,254,0.8)', borderRadius:8},{label:'è¿åŠ¨å®Œæˆåº¦ (%)', data:data2, backgroundColor:'rgba(255,159,64,0.8)', borderRadius:8}]}, options:{responsive:true, maintainAspectRatio:false}});}catch(e){}
        }
        function initOverallChart(){ const ctx=document.getElementById('overallChart'); if(!ctx) return; try{ new Chart(ctx,{type:'doughnut', data:{labels:['ä¼˜ç§€','è‰¯å¥½','å¾…æ”¹å–„','éœ€å…³æ³¨'], datasets:[{data:[45,38,12,5], backgroundColor:['#4facfe','#00f2fe','#ff9f43','#ff6b6b'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false}});}catch(e){} }
        function initDataCharts(){ const ctx=document.getElementById('dataOverallChart'); if(!ctx) return; try{ new Chart(ctx,{type:'pie', data:{labels:['ç³–å°¿ç—…','è‚¥èƒ–','ä»£è°¢ç»¼åˆå¾','å…¶ä»–'], datasets:[{data:[50,30,12,8], backgroundColor:['#4facfe','#00f2fe','#ff9f43','#ff6b6b']}]}, options:{responsive:true, maintainAspectRatio:false}});}catch(e){} }

        /* ================= æ•°æ®å¯¼å‡º ================= */
        function exportData(){ const range=document.getElementById('exportRange').value; const start=document.getElementById('exportStart').value; const end=document.getElementById('exportEnd').value; const fmt=document.getElementById('exportFormat').value; alert(`æ­£åœ¨å¯¼å‡º(${range}) ä» ${start} åˆ° ${end} æ ¼å¼:${fmt} (æ¨¡æ‹Ÿ)`); }
        function exportAllData(){ alert('æ­£åœ¨ç”ŸæˆExcelæŠ¥å‘Š...ï¼ˆæ¨¡æ‹Ÿï¼‰'); }
        function initDataQuality(){ document.getElementById('dataQualitySummary').innerHTML = `<p><strong>æ•°æ®å®Œæ•´æ€§:</strong> 94.2%<br><strong>æ‰“å¡ä¾ä»æ€§:</strong> 87.5%<br><strong>å¼‚å¸¸æ•°æ®:</strong> 3æ¡å¾…å®¡æ ¸<br><strong>æœ€åæ›´æ–°:</strong> ${new Date().toLocaleString()}</p>`; }
        function viewAnomalies(){ alert('æ‰“å¼€å¼‚å¸¸æ•°æ®è¯¦æƒ…ï¼ˆæ¨¡æ‹Ÿï¼‰'); }

        /* ================= ç§‘ç ” ================= */
        function createResearchProject(){ const name = document.getElementById('researchName').value.trim(); if(!name){ alert('è¯·å¡«å†™é¡¹ç›®åç§°'); return; } alert('ç ”ç©¶é¡¹ç›®å·²åˆ›å»º: '+name); }
        function generateStatReport(){ alert('æ­£åœ¨ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šï¼ˆæ¨¡æ‹Ÿï¼‰'); }

        /* ================= é¥®é£Ÿå›¾ç‰‡ä¸Šä¼ ï¼ˆéå›¾ç‰‡æ‹¦æˆªï¼‰ ================= */
        function uploadFoodImage(){
            const input = document.getElementById('foodImageInput');
            if(!input || input.files.length===0){ alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼'); return; }
            const file = input.files[0];
            const validImageTypes = ['image/jpeg','image/png','image/jpg','image/gif'];
            if(!validImageTypes.includes(file.type)){
                alert('è¯·ä¸Šä¼ å›¾ç‰‡æ ¼å¼æ–‡ä»¶ï¼ˆå¦‚ .jpgã€.pngã€.gifï¼‰ï¼');
                input.value=''; return;
            }
            const reader = new FileReader();
            reader.onload = function(e){
                const area = document.getElementById('foodAnalysisArea');
                area.innerHTML = `
                    <p>âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒAIåˆ†æä¸­...</p>
                    <img src="${e.target.result}" style="max-width:100%;margin-top:10px;border-radius:8px;" />
                    <p style="margin-top:10px;color:#555;">AIè¯†åˆ«ç»“æœï¼šç±³é¥­ã€é¸¡èƒ¸è‚‰ã€è¥¿å…°èŠ±ï¼Œä¼°ç®—çƒ­é‡çº¦ 480 åƒå¡ã€‚</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        /* ================= å‘é€å»ºè®® / ä¸‹è½½æŠ¥å‘Š ================= */
        function openSendAdviceModal(){
            document.getElementById('sendAdviceModal').style.display='block';
        }
        function closeSendAdviceModal(){
            document.getElementById('sendAdviceModal').style.display='none';
        }
        function confirmSendAdvice(){
            const txt = document.getElementById('adviceText').value.trim();
            if(!txt){ alert('è¯·è¾“å…¥å»ºè®®å†…å®¹'); return; }
            // æ¨¡æ‹Ÿå‘é€
            addMessageToStore(currentSelectedPatientId,'doctor',txt);
            renderChatBoard();
            document.getElementById('latestDoctorAdvice').textContent = txt;
            document.getElementById('latestAdviceTime').textContent = new Date().toLocaleString();
            closeSendAdviceModal();
            alert('å»ºè®®å·²å‘é€');
        }
        function downloadPatientReport(patientId){
            const p = patients.find(x=>x.id===patientId);
            if(!p){ alert('æ‚£è€…ä¸å­˜åœ¨'); return; }
            // æ¨¡æ‹Ÿç”ŸæˆæŠ¥å‘Š
            const report = `æ‚£è€…${p.name}(${p.id})æŠ¥å‘Š\nè¯Šæ–­ï¼š${p.disease}\næœ€åéšè®¿ï¼š${p.lastFollow}\nä¾ä»æ€§ï¼š${p.adherence}`;
            const blob = new Blob([report],{type:'text/plain;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ‚£è€…${p.name}æŠ¥å‘Š.txt`;
            a.click();
        }

        /* ================= å…¶ä»– ================= */
        function savePatientProfile(){ 
            const name=document.getElementById('patientNameInput').value; 
            const disease=document.getElementById('patientDisease').value; 
            const goal=document.getElementById('patientGoal').value; 
            alert('æ¡£æ¡ˆå·²ä¿å­˜ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰:'+name+','+disease+','+goal); 
            renderPatientFiles();
            renderDoctorReports();
        }
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); } });
    </script>
</body>
</html>